《速度与激情-以网站性能提升用户体验》读书笔记。

## 性能即用户体验
移动设备接收或者发送数据前，需要同网络建立一个无线传输通道。设备同无线基站通信询问何时能传输数据后，网络运营商首先将数据从无线基站传输到自己的内部网络，完后再传递到公网。这些步骤组合在一起容易造成十到数千毫秒的额外延迟。如果无线通道中没有数据传输时，超时会让通道进入空闲状态。
> “如今，延迟已经成为网络浏览体验的制约因素，而不是带宽”。</br>
>
> **延迟**是指数据包从一个点传输到另一个点所消耗的时间。延迟同基础的物理属性息息相关。</br>
> 
> **带宽**是通信通道的最大吞吐量，比如光纤或者你的移动服务商能够同时传输多少数据。</br>

为移动用户进行性能优化的一大好处就是，使用其他任何设备访问的用户也将同时从中受益。
#### 移动行为模式
优化网站的性能也对电池续航能力有影响。
#### 设计
设计阶段需要做出的决策：
- 颜色和渐变，影响图片格式的选择，是否需要透明度，需要创建多少CSS精灵图，以及需要使用多少CSS3属性
- 布局，影响HTML结构、类和ID名称、设计模式的复用功能以及CSS的组织形式
- 字体，影响包含的字体文件的大小和数量
- 设计模式，影响可以在整个网站中复用和缓存的内容，资源何时以及如何加载，以及未来设计师和开发者进行修改的难易程度
## 页面速度初探
#### 浏览器渲染
- 优化浏览器加载页面所需的请求的大小和数量
- 每一个连接都需要经过DNS查询，如果时https，还需要进行SSL协商。浏览器优化方式——**持久连接**，在下载完js文件后可以利用这个连接获取字体文件、图片等等。还可建立并发的持续连接，现代浏览器允许六条或八条**并发连接**。

#### 页面大小
使用YSlow插件可以查看页面每种内容的文件大小。
#### 关键渲染路径
> 浏览器从服务器取回HTML后对其进行解析：原始字节变成字符，字符组成的字符串变成类似\<body\>这样的标记，编辑变成用户属性和规则的对象，对象连接在一起变成一种特定的数据结构。最后创建DOM树，浏览器对页面的进一步处理都依赖它。

> 读取HTML过程中，遇到样式表，暂停所有事情，向服务器请求这个文件。收到后类似HTML那样，解析创建一个树结构，CSSOM(css Object Model)

> 将DOM和CSSOM组合在一起创建渲染树，渲染树用来计算所有可见元素的大小及位置。**渲染树只包含渲染页面所必须的内容，类似display:none这样的元素不会出现在渲染树中**，最后将渲染树展示在屏幕上。

**优化关键渲染路径的方法**</br>
- css被当作阻塞渲染的资源来处理，可以使用媒体类型和媒体查询来标识CSS的某些部分为非阻塞的。（不满足条件的css文件不会被加载）
- css在\<head\>中加载
- js阻塞DOM的构建，可声明为异步加载或者页面的最后加载js
- 异步加载内容
- 提高“第一屏”内容请求的优先级
- 缓存资源

#### 卡顿
当页面渲染速度低于每秒60帧(FPS)就会发生卡顿。

卡顿是浏览器在页面上绘制更新，改变一个元素的视觉属性（背景、颜色、边框半径或阴影），改变元素的可见性，或者点击一个轮播的内容。

#### 性能的其他因素
- 地理位置
- 网路
- 浏览器——浏览器处理请求和渲染内容的方式不同。例如不支持渐进式JPEG，就必须等待图片下载完成。

## 图片
#### 图片格式的选择
|格式 | 最佳使用场景 | 优化选项 |
|---|---|----|
|JPEG|有多种颜色的照片和图片 | 降低质量，输出为渐进式格式，降噪
|GIF|动画|减少抖动，减少颜色数量，增强横向模式，降低纵向噪点|
|PNG-8|颜色较少的图片|减少抖动，减少颜色数量，增增强横向和纵向模式|
|PNG-24|部分透明的图片|降噪，减少颜色数量|
**JEPG**</br>
- 照片和大量颜色的图片的首选
- 压缩优化——有损压缩
- 用Photoshop的“保存为网页格式”，图像文件包含更多的优化，并允许你调整图像的质量
- 渐进式JPGEG——以低清晰度马上显示出来，逐渐变得更加清晰，因此比基线JPGE有更好的用户体验</br>

**GIF**</br>
- 动画
- 支持透明度
- 256色
- 无损文件格式
- 保存为网页格式——可以设置抖动量和颜色数</br>

以下两种情况下可以使用GIF
- 同样的图像输出为GIF时比输出为PNG-8时体积更小(如果颜色更好并且内容分界清晰，PNG-8是更好的选择)
- 动画不能用css3实现

**PNG**</br>
- 无损，所以PNG格式体积通常是JPEG的**5倍至10倍**(如果文件中与不同的颜色且不需要透明度，JPEG更好)
- 透明度
- PNG识别水平模式和垂直模式，所以比GIF有更好的压缩
- **如果颜色少，PNG-8也许是最好的选择**

**压缩**</br>
如果能够将图片压缩的优化工作自动化——？？？
#### 替换图片请求
- 精灵图——合成一张图片，使用position定位素材
  - 精灵图需要经常大动干戈的修改
  - 用户可能永远使用不到精灵图中的某些内容
- css3
  - 可以处理透明度
  - 可以同背景叠加
  - 减少一个图片请求
  - 极易修改
> 为了支持更多的浏览器，将渐变应用在元素的background-image。对于不支持css3渐变的低版本IE，可以使用filter
- Data URI和Base64编码图像
  - 行内图像无法进行缓存,并使css文件体积增大。更换时请进行测试确保这种转换确实带来性能提升。
- SVG：单色或者渐变的，透明的，或者只有非常少的细节的可以输出成SVG
  - 应用到<img>元素
  - 应用到background上
  - 行内
####  图片使用规划和改进
- 创建样式指南——团队中比较好的方式

## 优化HTML标记和样式
#### 简化HTML
- 使用HTML5语义化元素
#### 简化CSS
- 删除未使用css
- 合并和精简样式
  - 合并创建共享样式
  - 制定易遵循的间距和字体大小等规则
  - 利用简写属性
  - 对元素重命名
- 精简样式图片
- 去除特殊性
#### 优化网络字体
使用媒体查询，只在大屏幕上使用网络字体。
#### 创建可复用HTML标记
样式指南
#### 关于HTML的进一步优化
- \<head\>中加载css
- 页面的最后加载JavaScript，并尽可能异步——async或者defer
- 大型网站，设置一个全站的样式并且缓存，其他页面只需要下载一个小的额外样式
- 压缩——服务器上开启gzip压缩
- 资源缓存
  - 设置响应头进行缓存
    - Expires或Cache-Control：max-age缓存
    - Last-Modified或ETag换成怒
  - 静态资源缓存——js、css、图片、pdf、字体
  - 服务器缓存——NGINX内容缓存

## 响应式设计
#### picture元素
html5的picture元素，根据media属性加载对应元素
```
<picture>
  <source srcset="mdn-logo-wide.png" media="(min-width: 600px)">
  <img src="mdn-logo-narrow.png" alt="MDN">
</picture>
```
type属性可以指定一个MIME类型，如果用户代理不支持，会跳过该source
```
<picture>
  <source srcset="mdn-logo.svg" type="image/svg+xml">
  <img src="mdn-logo.png" alt="MDN">
</picture>
```
#### img元素的sizes属性
sizes和srcset属性一起使用。sizes属性可以使用媒体条件查询，代理可以根据该条件决定是否加载图像
#### 移动优先
移动优先可以帮助我们决定网站的核心内容，决定为用户提供更重要的功能和内容。

## 性能评估
可以使用YSlow和chrome开发者工具、webpagetest测试网站性能。</br>
google analytics等等真实用户监控工具。

## 改变组织文化
创建和维护一流网站性能的最大障碍是组织文化。
